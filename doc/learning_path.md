# AddressSanitizer玩具项目学习路径

## 项目目标

从零开始构建一个最小化的AddressSanitizer（ASan），能够检测C程序中的堆缓冲区溢出错误。

## 技术栈

- **语言**: C语言
- **平台**: Linux
- **核心系统调用**: mmap, mprotect, signal处理

## 重新设计的学习路径

### 阶段0：Linux内存管理基础概念

#### 概念1：虚拟内存与物理内存
- **学习目标**: 理解进程如何看待内存
- **关键问题**:
  - 什么是虚拟地址空间？
  - 进程如何看到内存？
  - 页面是什么概念？
- **实践练习**: 写程序显示自己的内存布局

#### 概念2：mmap系统调用
- **学习目标**: 掌握内存映射的基本用法
- **关键问题**:
  - mmap的作用：将文件或设备映射到内存
  - 如何用mmap分配匿名内存（相当于malloc）
  - mmap返回的地址是什么意思？
- **实践练习**: 写一个最简单的mmap程序

#### 概念3：内存保护权限
- **学习目标**: 理解内存权限控制机制
- **关键问题**:
  - 什么是PROT_READ, PROT_WRITE, PROT_NONE？
  - mprotect的作用：动态修改内存权限
- **实践练习**: 用mprotect创建一个"只读"区域，然后尝试写入

### 阶段1：信号处理机制

#### 概念1：什么是信号
- **学习目标**: 理解Linux信号机制
- **关键问题**:
  - 信号就像"软件中断"
  - SIGSEGV是什么？（段错误信号）
  - 信号和异常的关系
- **实践练习**: 观察不同类型错误产生的信号

#### 概念2：信号处理器
- **学习目标**: 掌握信号处理函数的编写
- **关键问题**:
  - 如何注册自定义信号处理函数
  - signal() vs sigaction()的区别
- **实践练习**: 写一个捕获SIGSEGV的程序

#### 概念3：从信号中恢复
- **学习目标**: 学会从信号中获取调试信息
- **关键问题**:
  - 信号处理器能做什么？
  - 如何判断错误发生的地址？
- **实践练习**: 在信号处理器中打印错误信息

### 阶段2：理解内存错误类型

#### 概念1：缓冲区溢出
- **学习目标**: 理解各种缓冲区溢出
- **关键问题**:
  - 什么是堆溢出？什么是栈溢出？
  - 越界写入的后果
- **实践练习**: 写一个故意缓冲区溢出的程序

#### 概念2：Use-after-free
- **学习目标**: 理解释放后使用的危险
- **关键问题**:
  - 释放后继续使用的危险
  - 双重释放问题
- **实践练习**: 写一个use-after-free的例子

### 阶段3：ASan核心原理实验

#### 实验1：手动创建保护页
- **目标**: 理解保护页的工作原理
- **步骤**:
  1. 用mmap分配3页内存
  2. 中间页可读写，两边页设为PROT_NONE
  3. 尝试访问左边或右边的保护页
  4. 观察SIGSEGV的发生

#### 实验2：理解"红区"概念
- **目标**: 理解红区的作用
- **步骤**:
  1. 在分配的内存前后创建不可访问区域
  2. 验证越界访问会被捕获

### 阶段4：构建玩具ASan

#### 第一步：最简单的内存分配器
```c
// 目标：理解基本原理
void* toy_malloc(size_t size) {
    // 分配 size + 2*page_size
    // 设置左边页为PROT_NONE（红区）
    // 返回中间可用的地址
}
```

#### 第二步：添加信号处理
```c
// 注册SIGSEGV处理器
// 在处理器中判断是否是我们的保护页
// 打印友好的错误信息
```

#### 第三步：集成测试
- 用我们的toy_malloc替换程序中的malloc
- 测试是否能捕获越界访问

## 具体学习步骤

### 第1天：内存基础
1. 写一个简单的mmap程序
2. 理解虚拟内存布局
3. 实验mprotect的使用

### 第2天：信号处理
1. 写一个捕获SIGSEGV的程序
2. 学会从信号中获取错误信息
3. 理解信号的异步特性

### 第3天：手动ASan
1. 手动创建带保护页的内存分配
2. 验证保护机制工作
3. 理解为什么这种方法"零开销"

### 第4-5天：玩具ASan实现
1. 实现基本的内存分配器
2. 添加错误检测和报告
3. 测试和优化

## 学习方式

每个概念我们都采用"理论→实验→理解"的三步法：

1. **理论**: 解释概念和原理
2. **实验**: 写最小的验证代码
3. **理解**: 通过实验结果加深理解

## 项目文件结构

```
AddressSanitizer_learning/
├── doc/                    # 学习文档
│   ├── learning_path.md    # 学习路径（本文档）
│   ├── concepts/           # 概念学习文档
│   ├── experiments/        # 实验指导文档
│   └── implementation/     # 实现文档
├── src/                    # 源代码
│   ├── experiments/        # 实验代码
│   ├── toy_asan/          # 玩具ASan实现
│   └── tests/             # 测试代码
├── README.md              # 项目总览
└── Makefile               # 构建脚本
```

## 目标测试程序

我们将以这个最简单的C程序为目标，最终能检测其内存越界错误：

```c
#include <stdlib.h>
#include <string.h>

int main() {
    char *buf = malloc(10);
    strcpy(buf, "This string is definitely longer than 10 bytes");
    buf[15] = 'x';  // 这应该触发我们的ASan
    return 0;
}
```

## 成功标准

完成本项目后，你应该能够：
1. 理解Linux内存管理的基本概念
2. 掌握信号处理机制
3. 理解ASan的核心工作原理
4. 能够实现基本的内存错误检测工具
5. 对系统级编程有深入的理解

---

*准备好开始学习了吗？让我们从第一个概念开始：虚拟内存与mmap！*
